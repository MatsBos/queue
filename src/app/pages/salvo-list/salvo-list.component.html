<main class="h-full flex flex-col bg-linear-to-br from-slate-950 via-slate-900 to-slate-950">
    <div class="flex flex-col h-full">
        <!-- Main Salvo List Area -->
        <div cdkScrollable class="drag-container flex-1 overflow-y-auto px-4 py-6">
            <div cdkScrollable cdkDropList #salvoDropList="cdkDropList" [cdkDropListData]="salvoList()"
                class="drag-list pb-10 mx-auto" (cdkDropListDropped)="drop($event)">
                @for (salvoItem of salvoList(); track $index) {
                <div #salvoEl class="drag-box my-3 py-0 px-6 rounded-xl shadow-lg transition-all duration-300 "
                    [ngClass]="salvoItem.isBreak ? 'h-32 mb-6 border-2 border-dashed' : 'border border-white/10'"
                    [class.grayed-out]="salvoItem.done"
                    [style.background-color]="salvoItem.sourceItem?.colorHex ? salvoItem.sourceItem?.colorHex + 'dd' : '#1e293bdd'"
                    [style.color]="salvoItem.sourceItem?.colorHex || '#000000' | contrastTextColor"
                    (click)="toggleSalvoDone(salvoItem)" cdkDrag>

                    <div class="flex items-center gap-6 h-full">
                        <!-- Left side: Order number and dropdown -->
                        <div class="flex items-center gap-4 shrink-0 w-64">
                            <div
                                class="w-12 h-12 rounded-full bg-black/20 flex items-center justify-center font-bold text-xl">
                                {{ (salvoItem.order ?? 0) + 1 }}
                            </div>

                            <app-salvo-dropdown class="min-w-[120px]"
                                [currentOption]="salvoItem.extraInfo ? salvoItem.extraInfo : ''"
                                (valueChange)="dropDownValueChanges($event, salvoItem)"
                                (click)="$event.stopPropagation()">
                            </app-salvo-dropdown>
                        </div>

                        <!-- Center: Title -->
                        <h1 class="flex-1 text-6xl text-center tracking-wide" [class.text-3xl]="salvoItem.isBreak">
                            @if(salvoItem.isBreak){
                            <span class="italic opacity-75">{{salvoItem.sourceItem?.name}}</span>
                            }
                            @else{
                            {{salvoItem.sourceItem?.name}}
                            }
                        </h1>

                        <!-- Right side: Actions -->
                        <div class="flex items-center gap-2 shrink-0 w-64 justify-end">
                            <mat-slide-toggle (click)="$event.stopPropagation()"
                                (toggleChange)="toggleSalvoDone(salvoItem)" [checked]="salvoItem.done"
                                class="scale-110">
                            </mat-slide-toggle>
                            <button mat-icon-button (click)="$event.stopPropagation();deleteSalvoItem(salvoItem.id!)"
                                class="hover:bg-black/20 transition-colors rounded-full">
                                <mat-icon
                                    [style.color]="salvoItem.sourceItem?.colorHex || '#000000' | contrastTextColor">
                                    delete
                                </mat-icon>
                            </button>
                        </div>
                    </div>

                </div>
                }
            </div>
        </div>

        <!-- Bottom Control Panel -->
        <div class="border-t border-white/10 bg-linear-to-b from-slate-900 to-slate-950 backdrop-blur-xl shadow-2xl">
            <div class="p-2 mx-auto">
                <!-- Header Row -->
                <div class="flex justify-between items-center mb-6">
                    <div class="flex gap-1 items-center flex-wrap">
                        <h2 class="font-bold text-white  tracking-wide flex items-center gap-2">
                            Source Manager
                        </h2>
                        <div class="h-6 w-px bg-white/20"></div>
                        <button matButton="outlined" (click)="clearAllSalvos()"
                            class="rounded-lg hover:bg-red-500/20 hover:border-red-400 transition-all">
                            <mat-icon>delete_sweep</mat-icon>
                            Clear All Salvos
                        </button>
                        <button matButton="outlined" (click)="clearAllSources()"
                            class="rounded-lg hover:bg-red-500/20 hover:border-red-400 transition-all">
                            <mat-icon>delete_sweep</mat-icon>
                            Clear All Sources
                        </button>
                        <button matButton="outlined" (click)="addSource()"
                            class="rounded-lg hover:bg-green-500/20 hover:border-green-400 transition-all">
                            <mat-icon>add_circle</mat-icon>
                            Add Source
                        </button>
                        <button [matButton]="editSourceMode() ? 'filled':'outlined'"
                            (click)="editSourceMode.set(!editSourceMode())" class="rounded-lg transition-all"
                            [class.bg-blue-600]="editSourceMode()" [class.hover:bg-blue-700]="editSourceMode()">
                            <mat-icon>{{editSourceMode() ? 'edit_off' : 'edit'}}</mat-icon>
                            {{editSourceMode() ? 'Done Editing' : 'Edit Sources'}}
                        </button>
                    </div>
                    <button matButton="outlined" (click)="selectNext()"
                        class="rounded-lg hover:bg-blue-500/20 hover:border-blue-400 transition-all">
                        <mat-icon>keyboard_arrow_down</mat-icon>
                        Select Next
                    </button>
                </div>

                <!-- Source Items Grid -->
                <ul role="list" class="flex gap-3 flex-wrap justify-center" cdkDropList [cdkDropListData]="sourceList()"
                    [cdkDropListConnectedTo]="[salvoDropList]">
                    @for (sourceItem of sourceList(); track $index) {
                    <li [class.border-dashed]="sourceItem.isBreak"
                        class="rounded-xl p-2 text-center items-center cursor-pointer text-xl flex border-2 text-nowrap border-white/30 shadow-lg transition-all duration-300 hover:shadow-xl hover:scale-105 hover:border-white/50 backdrop-blur-sm min-w-[140px]"
                        [class]="sourceItem.isBreak ? 'justify-center':'justify-between'" cdkDrag
                        [cdkDragData]="sourceItem"
                        [style.background-color]="sourceItem.colorHex ? sourceItem.colorHex + 'ee' : '#334155ee'"
                        [style.color]="sourceItem.colorHex | contrastTextColor" (click)="tapSourceItem(sourceItem)">

                        <span class="font-medium" [class.italic]="sourceItem.isBreak">
                            @if(sourceItem.isBreak){
                            -- {{sourceItem.name}} --
                            }
                            @else{
                            {{sourceItem.name}}
                            }
                        </span>

                        @if (editSourceMode()) {
                        <div class="flex gap-1 ml-2">
                            <button mat-icon-button [style.color]="sourceItem.colorHex | contrastTextColor"
                                (click)="deleteSource(sourceItem.id!);$event.stopPropagation();"
                                class="hover:bg-black/20 transition-colors rounded-full scale-90">
                                <mat-icon>delete</mat-icon>
                            </button>

                            <button mat-icon-button [style.color]="sourceItem.colorHex | contrastTextColor"
                                (click)="editSource(sourceItem);$event.stopPropagation();"
                                class="hover:bg-black/20 transition-colors rounded-full scale-90">
                                <mat-icon>edit</mat-icon>
                            </button>
                        </div>
                        }
                    </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</main>